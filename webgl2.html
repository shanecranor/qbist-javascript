<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Animated Qbist in Worker - Fullscreen</title>
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        height: 100%;
        background: #222;
        overflow: hidden;
      }
      canvas {
        display: block;
        width: 100vw;
        height: 100vh;
      }
      #fps {
        position: fixed;
        top: 10px;
        right: 10px;
        background: rgba(0, 0, 0, 0.5);
        color: white;
        padding: 5px 10px;
        border-radius: 4px;
        font-family: monospace;
      }
    </style>
  </head>
  <body>
    <canvas id="canvas"></canvas>
    <div id="fps">FPS: --</div>
    <script type="module">
      import { createInfo } from "./qbist.js"

      const urlParams = new URLSearchParams(window.location.search)
      let info = createInfo() // Default pattern if no state provided

      if (urlParams.has("state")) {
        try {
          const stateJSON = atob(urlParams.get("state"))
          const stateObj = JSON.parse(stateJSON)
          if (
            stateObj.transformSequence &&
            stateObj.source &&
            stateObj.control &&
            stateObj.dest
          ) {
            info = stateObj
          }
        } catch (e) {
          console.error("Error loading state:", e)
        }
      }

      const canvas = document.getElementById("canvas")
      const fpsDisplay = document.getElementById("fps")

      // Transfer control to an OffscreenCanvas.
      const offscreen = canvas.transferControlToOffscreen()

      // Create and start the worker.
      const worker = new Worker("./workerWebGL.js", { type: "module" })

      // Handle messages from worker including FPS updates
      worker.onmessage = (e) => {
        if (e.data.command === "fps") {
          console.log("FP2S:", e.data.fps)
          fpsDisplay.textContent = `FPS: ${e.data.fps.toFixed(1)}`
        }
        // Handle any other messages normally
      }

      // Initialize with the pattern info and animation enabled
      worker.postMessage(
        {
          type: "init",
          canvas: offscreen,
          width: window.innerWidth,
          height: window.innerHeight,
          info: info,
          keepAlive: true,
        },
        [offscreen]
      )

      // Handle window resize
      window.addEventListener("resize", () => {
        const width = window.innerWidth
        const height = window.innerHeight
        worker.postMessage({
          type: "update",
          width: width,
          height: height,
        })
      })
    </script>
  </body>
</html>
