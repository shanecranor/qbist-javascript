<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Animated Qbist in Worker - Fullscreen</title>
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        height: 100%;
        background: #222;
        overflow: hidden;
      }
      canvas {
        display: block;
        width: 100vw;
        height: 100vh;
      }
    </style>
  </head>
  <body>
    <canvas id="canvas"></canvas>
    <script type="module">
      import { createInfo } from "./qbist.js"

      const urlParams = new URLSearchParams(window.location.search)
      let info = createInfo() // Default pattern if no state provided

      if (urlParams.has("state")) {
        try {
          const stateJSON = atob(urlParams.get("state"))
          const stateObj = JSON.parse(stateJSON)
          if (
            stateObj.transformSequence &&
            stateObj.source &&
            stateObj.control &&
            stateObj.dest
          ) {
            info = stateObj
          }
        } catch (e) {
          console.error("Error loading state:", e)
        }
      }

      const canvas = document.getElementById("canvas")
      function resizeCanvas() {
        canvas.width = window.innerWidth
        canvas.height = window.innerHeight
      }
      resizeCanvas()

      // Transfer control to an OffscreenCanvas.
      const offscreen = canvas.transferControlToOffscreen()

      // Create and start the worker.
      const worker = new Worker("./workerWebGL.js", { type: "module" })

      // Initialize with the pattern info and animation enabled
      worker.postMessage(
        {
          type: "init",
          canvas: offscreen,
          info: info,
          keepAlive: true,
          refreshEveryFrame: true,
        },
        [offscreen]
      )

      // Handle window resize
      window.addEventListener("resize", () => {
        const width = window.innerWidth
        const height = window.innerHeight
        worker.postMessage({
          type: "update",
          info: info,
          keepAlive: true,
          refreshEveryFrame: true,
        })
        // Update resolution uniform
        const gl = canvas.getContext("webgl2")
        if (gl) {
          gl.viewport(0, 0, width, height)
        }
      })
    </script>
  </body>
</html>
